<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>EduStat Pro - Gestion Compl√®te des Notes</title>
    <style>
        /* ==================== STYLES CONSERV√âS ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 32px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(145deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px 24px;
        }

        .header h1 {
            font-size: clamp(1.8rem, 5vw, 2.4rem);
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header p {
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            opacity: 0.95;
        }

        .main-content {
            padding: 20px;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
            flex-wrap: wrap;
            gap: 8px;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #e2e8f0;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            background: white;
            padding: 10px 20px;
            border-radius: 40px;
            font-size: clamp(0.8rem, 2.5vw, 0.95rem);
            font-weight: 600;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
            min-width: fit-content;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .step.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
            transform: scale(1.02);
        }

        .step.completed {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .class-selector {
            background: linear-gradient(145deg, #4f46e5, #7c3aed);
            padding: 30px 20px;
            border-radius: 28px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .class-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .class-btn {
            padding: 12px 24px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: clamp(0.95rem, 3vw, 1.1rem);
            font-weight: 600;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
            min-width: 80px;
        }

        .class-btn:hover, .class-btn.active {
            background: white;
            color: #4f46e5;
            transform: translateY(-3px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(145deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px 16px;
            border-radius: 24px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
        }

        .stat-card h3 {
            font-size: clamp(0.8rem, 2.5vw, 0.95rem);
            margin-bottom: 8px;
            opacity: 0.95;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: clamp(1.8rem, 5vw, 2.2rem);
            font-weight: 700;
            line-height: 1;
        }

        .stat-card small {
            font-size: 0.8rem;
            opacity: 0.8;
            display: block;
            margin-top: 4px;
        }

        .stats-showcase {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 30px;
        }

        .stat-panel {
            background: white;
            border-radius: 28px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid #f1f5f9;
        }

        .stat-panel h2 {
            color: #1e293b;
            font-size: 1.4rem;
            margin-bottom: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 3px solid #f1f5f9;
            padding-bottom: 12px;
        }

        .stat-panel h2 span {
            background: #4f46e5;
            color: white;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.9rem;
        }

        .pie-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .pie-chart-big {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            margin: 10px auto;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            border: 6px solid white;
        }

        .pie-legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            background: #f8fafc;
            border-radius: 50px;
            font-size: 0.95rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 8px;
        }

        .legend-stats {
            font-weight: 600;
            color: #1e293b;
        }

        .legend-percent {
            color: #64748b;
            font-size: 0.9rem;
            margin-left: auto;
        }

        .stats-bars {
            margin-top: 20px;
        }

        .stat-bar-item {
            margin-bottom: 20px;
        }

        .stat-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-bar-bg {
            height: 36px;
            background: #f1f5f9;
            border-radius: 50px;
            overflow: hidden;
            position: relative;
        }

        .stat-bar-fill {
            height: 100%;
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            transition: width 0.3s ease;
        }

        .color-male { background: #3b82f6; }
        .color-female { background: #ec4899; }
        .color-nouveau { background: #10b981; }
        .color-nouvelle { background: #14b8a6; }
        .color-ancien { background: #f59e0b; }
        .color-ancienne { background: #ef4444; }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.95rem;
        }

        th {
            background: #f8fafc;
            color: #1e293b;
            padding: 16px 12px;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        .note-input {
            width: 75px;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .note-input:focus {
            border-color: #4f46e5;
            outline: none;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .sex-m { background: #dbeafe; color: #1e40af; }
        .sex-f { background: #fce7f3; color: #9d174d; }
        
        .status-nouveau { background: #d1fae5; color: #065f46; }
        .status-nouvelle { background: #ccfbf1; color: #115e59; }
        .status-ancien { background: #fed7aa; color: #92400e; }
        .status-ancienne { background: #fee2e2; color: #991b1b; }

        .badge-excellent {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-critical {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .ranking-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .ranking-box {
            background: white;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #f1f5f9;
        }

        .ranking-box h3 {
            color: #1e293b;
            font-size: 1.1rem;
            margin-bottom: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .rank-position {
            font-weight: 700;
            width: 35px;
            color: #4f46e5;
        }

        .rank-name {
            flex: 1;
            margin-left: 10px;
            font-weight: 500;
        }

        .rank-note {
            font-weight: 700;
            margin-right: 10px;
        }

        .rank-note.high { color: #10b981; }
        .rank-note.low { color: #ef4444; }

        .rank-actions {
            display: flex;
            gap: 6px;
        }

        .btn-icon {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            background: #f1f5f9;
        }

        .btn-icon.btn-whatsapp { background: #25D366; color: white; }
        .btn-icon.btn-sms { background: #3b82f6; color: white; }

        .btn-icon:hover {
            transform: translateY(-2px);
        }

        .notif-section, .whatsapp-section, .sms-section, .csv-section {
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .notif-section {
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            border: 1px solid #cbd5e1;
        }

        .whatsapp-section {
            background: linear-gradient(145deg, #f0f9f0, #e6f3e6);
            border: 1px solid #25D36640;
        }

        .sms-section {
            background: linear-gradient(145deg, #eff6ff, #dbeafe);
            border: 1px solid #3b82f640;
        }

        .csv-section {
            background: linear-gradient(145deg, #fff0f0, #ffe6e6);
            border: 1px solid #FF6B6B40;
        }

        .input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .input-group input {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid;
            border-radius: 40px;
            font-size: 0.95rem;
        }

        .whatsapp-section input { border-color: #25D366; }
        .sms-section input { border-color: #3b82f6; }

        .threshold-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border-radius: 40px;
            background: white;
            border: 1px solid #e2e8f0;
            font-size: 0.85rem;
        }

        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #f1f5f9;
            color: #1e293b;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: #4f46e5; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-sms { background: #3b82f6; color: white; }
        .btn-csv { background: #FF6B6B; color: white; }
        .btn-secondary { background: #64748b; color: white; }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .alert {
            padding: 14px 20px;
            border-radius: 40px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            font-weight: 500;
        }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        .history-section {
            background: white;
            border-radius: 24px;
            padding: 20px;
            margin-top: 24px;
            border: 1px solid #f1f5f9;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #64748b;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .stats-showcase { grid-template-columns: 1fr; }
            .main-content { padding: 16px; }
            .step { padding: 8px 12px; }
            .btn { padding: 8px 16px; }
            .history-item { flex-direction: column; align-items: flex-start; }
            .history-stats { width: 100%; justify-content: space-between; }
            .input-group { flex-direction: column; }
            .input-group input { width: 100%; }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-content {
            display: none;
            animation: slideIn 0.3s ease;
        }

        .step-content.active {
            display: block;
        }

        .chart-box {
            background: white;
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #f1f5f9;
        }

        .progress-item {
            margin-bottom: 15px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä EduStat Pro</h1>
            <p>Gestion compl√®te des notes ‚Ä¢ Alertes parents ‚Ä¢ Statistiques ‚Ä¢ Exports CSV</p>
        </div>

        <div class="main-content">
            <!-- Navigation par √©tapes -->
            <div class="steps">
                <div class="step active" onclick="goToStep(1)" id="step1">1. Classe</div>
                <div class="step" onclick="goToStep(2)" id="step2">2. √âl√®ves</div>
                <div class="step" onclick="goToStep(3)" id="step3">3. Notes</div>
                <div class="step" onclick="goToStep(4)" id="step4">4. Statistiques</div>
            </div>

            <!-- √âTAPE 1 : Choix de la classe -->
            <div id="step1-content" class="step-content active">
                <div class="class-selector">
                    <h2 style="font-size: 1.8rem; margin-bottom: 20px;">üìö S√©lectionner une classe</h2>
                    <div class="class-buttons">
                        <button class="class-btn" onclick="selectClass('6√®me')">6√®me</button>
                        <button class="class-btn" onclick="selectClass('5√®me')">5√®me</button>
                        <button class="class-btn" onclick="selectClass('4√®me')">4√®me</button>
                        <button class="class-btn" onclick="selectClass('3√®me')">3√®me</button>
                        <button class="class-btn" onclick="selectClass('2nde')">2nde</button>
                        <button class="class-btn" onclick="selectClass('1√®re')">1√®re</button>
                        <button class="class-btn" onclick="selectClass('Tle')">Terminale</button>
                    </div>
                </div>
            </div>

            <!-- √âTAPE 2 : Gestion des √©l√®ves -->
            <div id="step2-content" class="step-content">
                <h2 style="margin-bottom: 20px; color: #1e293b;">üë• Gestion des √©l√®ves - <span id="currentClass2">...</span></h2>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="showAddForm()">‚ûï Ajouter un √©l√®ve</button>
                    <button class="btn btn-primary" onclick="showImportForm()">üì• Importer JSON</button>
                    <button class="btn btn-secondary" onclick="downloadTemplate()">üìÑ Mod√®le JSON</button>
                </div>

                <div id="alertMessage2" class="alert" style="display: none;"></div>

                <!-- Formulaire d'ajout -->
                <div id="addForm" style="display: none; margin: 20px 0;">
                    <div class="chart-box">
                        <h3 style="margin-bottom: 15px;">Nouvel √©l√®ve</h3>
                        <input type="text" id="newTableNum" placeholder="N¬∞ table (ex: T001)" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 40px;">
                        <input type="text" id="newName" placeholder="Nom complet" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 40px;">
                        <input type="text" id="newParentPhone" placeholder="T√©l√©phone parent (ex: 90000000)" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 40px;">
                        <select id="newSex" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 40px;">
                            <option value="M">Masculin</option>
                            <option value="F">F√©minin</option>
                        </select>
                        <select id="newStatus" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 40px;">
                            <option value="nouveau">Nouveau</option>
                            <option value="nouvelle">Nouvelle</option>
                            <option value="ancien">Ancien</option>
                            <option value="ancienne">Ancienne</option>
                        </select>
                        <button class="btn btn-primary" onclick="addStudent()" style="width: 100%;">‚úÖ Valider</button>
                    </div>
                </div>

                <!-- Formulaire d'import JSON -->
                <div id="importForm" style="display: none; margin: 20px 0;">
                    <div class="chart-box">
                        <h3 style="margin-bottom: 15px;">Import JSON</h3>
                        <textarea id="jsonImport" rows="5" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 20px; font-family: monospace;">[
    {
        "tableNum": "T001",
        "name": "Jean Koffi",
        "parentPhone": "90000000",
        "sex": "M",
        "status": "nouveau",
        "note": 0
    }
]</textarea>
                        <div class="actions" style="margin-top: 12px;">
                            <button class="btn btn-success" onclick="importJSON()">Importer</button>
                            <button class="btn btn-secondary" onclick="downloadTemplate()">T√©l√©charger mod√®le</button>
                        </div>
                    </div>
                </div>

                <!-- Liste des √©l√®ves -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Table</th>
                                <th>Nom</th>
                                <th>Parent</th>
                                <th>Sexe</th>
                                <th>Statut</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="registeredStudents"></tbody>
                    </table>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="goToStep(3)">√âtape suivante : Saisie des notes ‚Üí</button>
                </div>
            </div>

            <!-- √âTAPE 3 : Saisie des notes -->
            <div id="step3-content" class="step-content">
                <h2 style="margin-bottom: 20px; color: #1e293b;">üìù Saisie des notes - <span id="currentClass3">...</span></h2>

                <!-- Filtres -->
                <div class="filters-section" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; background: #f8fafc; padding: 16px; border-radius: 40px;">
                    <input type="text" id="tableFilter" placeholder="üîç Filtrer par table" style="flex: 2; min-width: 150px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 40px;">
                    <select id="sexFilter" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 40px;">
                        <option value="all">Tous sexes</option>
                        <option value="M">Masculin</option>
                        <option value="F">F√©minin</option>
                    </select>
                    <select id="statusFilter" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 40px;">
                        <option value="all">Tous statuts</option>
                        <option value="nouveau">Nouveau</option>
                        <option value="nouvelle">Nouvelle</option>
                        <option value="ancien">Ancien</option>
                        <option value="ancienne">Ancienne</option>
                    </select>
                    <button class="btn btn-primary" onclick="applyFilters()">Appliquer</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                </div>

                <!-- Statistiques rapides -->
                <div class="stats-grid">
                    <div class="stat-card"><h3>üë• √âl√®ves</h3><div class="value" id="totalStudents">0</div></div>
                    <div class="stat-card"><h3>üìä Moyenne</h3><div class="value" id="globalAverage">0.0</div></div>
                    <div class="stat-card"><h3>‚ôÇ Gar√ßons</h3><div class="value" id="totalBoys">0</div></div>
                    <div class="stat-card"><h3>‚ôÄ Filles</h3><div class="value" id="totalGirls">0</div></div>
                </div>

                <!-- Tableau des notes -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Table</th>
                                <th>Nom</th>
                                <th>Parent</th>
                                <th>Sexe</th>
                                <th>Statut</th>
                                <th>Note /20</th>
                                <th>Observation</th>
                                <th>Alerte</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>

                <div class="actions">
                    <button class="btn btn-success" onclick="saveAllNotes()">üíæ Enregistrer toutes les notes</button>
                    <button class="btn btn-primary" onclick="goToStep(4)">üìä Voir statistiques ‚Üí</button>
                </div>
            </div>

            <!-- √âTAPE 4 : STATISTIQUES D√âTAILL√âES -->
            <div id="step4-content" class="step-content">
                <h2 style="margin-bottom: 20px; color: #1e293b;">üìä Statistiques d√©taill√©es - <span id="currentClass4">...</span></h2>

                <!-- Section Alertes automatiques -->
                <div class="notif-section">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <span style="font-size: 2rem;">‚ö°</span>
                        <h3 style="font-size: 1.3rem;">Alertes automatiques aux parents</h3>
                    </div>
                    
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 20px;">
                        <div class="threshold-badge"><span style="color:#10b981;">‚óè</span> Excellence : note ‚â• 15</div>
                        <div class="threshold-badge"><span style="color:#ef4444;">‚óè</span> Critique : note ‚â§ 8</div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-whatsapp" onclick="notifyExcellentStudents()">üì± F√©licitations WhatsApp (‚â•15)</button>
                        <button class="btn btn-whatsapp" onclick="notifyCriticalStudents()">‚ö†Ô∏è Alertes WhatsApp (‚â§8)</button>
                        <button class="btn btn-sms" onclick="notifyExcellentStudentsSMS()">üì® F√©licitations SMS (‚â•15)</button>
                        <button class="btn btn-sms" onclick="notifyCriticalStudentsSMS()">üì® Alertes SMS (‚â§8)</button>
                    </div>
                </div>

                <!-- Communications globales -->
                <div class="whatsapp-section">
                    <div class="input-group">
                        <span class="badge" style="background:#25D366; color:white; font-size:1rem;">+228</span>
                        <input type="text" id="whatsappNumber" placeholder="Num√©ro WhatsApp (ex: 90000000)" value="90000000">
                        <button class="btn btn-whatsapp" onclick="sendStatsToWhatsApp()">üì§ Envoyer stats classe</button>
                    </div>
                </div>

                <div class="sms-section">
                    <div class="input-group">
                        <span class="badge" style="background:#3b82f6; color:white; font-size:1rem;">SMS</span>
                        <input type="text" id="smsCenterNumber" placeholder="Num√©ro destinataire" value="90000000">
                        <button class="btn btn-sms" onclick="sendBulkSMS()">üì§ SMS √† tous les parents</button>
                    </div>
                </div>

                <!-- CSV Section -->
                <div class="csv-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                        <div>
                            <h4 style="color: #FF6B6B; font-size: 1.2rem;">üìÅ Visualisation CSV</h4>
                            <p style="color: #4b5563;">Analysez vos exports avec Smart CSV Viewer</p>
                        </div>
                        <a href="https://play.google.com/store/apps/details?id=xyz.minimalistapps.smartcsv" 
                           target="_blank" class="btn btn-csv">üì≤ T√©l√©charger Smart CSV</a>
                    </div>
                </div>

                <!-- Top √©l√®ves -->
                <div class="ranking-container">
                    <div class="ranking-box">
                        <h3>üèÜ √âl√®ves excellents (‚â•15)</h3>
                        <div id="excellentStudents"></div>
                    </div>
                    <div class="ranking-box">
                        <h3>‚ö†Ô∏è √âl√®ves critiques (‚â§8)</h3>
                        <div id="criticalStudents"></div>
                    </div>
                </div>

                <!-- Cartes statistiques g√©n√©rales -->
                <div class="stats-grid">
                    <div class="stat-card"><h3>üë• Total</h3><div class="value" id="totalStudents4">0</div></div>
                    <div class="stat-card"><h3>üìä Moyenne</h3><div class="value" id="globalAvg4">0.0</div></div>
                    <div class="stat-card"><h3>‚úÖ R√©ussite</h3><div class="value" id="successRate4">0%</div></div>
                    <div class="stat-card"><h3>üèÜ Max</h3><div class="value" id="maxNote4">0</div></div>
                    <div class="stat-card"><h3>üèÜ Excellents</h3><div class="value" id="excellentCount4">0</div></div>
                    <div class="stat-card"><h3>‚ö†Ô∏è Critiques</h3><div class="value" id="criticalCount4">0</div></div>
                </div>

                <!-- PANEL STATISTIQUES PAR SEXE ET STATUT -->
                <div class="stats-showcase">
                    <!-- Par sexe -->
                    <div class="stat-panel">
                        <h2>üë§ Statistiques par sexe <span id="sexCount">0 √©l√®ves</span></h2>
                        
                        <div class="pie-container">
                            <div class="pie-chart-big" id="sexPieChart"></div>
                            
                            <div class="pie-legend-grid">
                                <div class="legend-item">
                                    <div class="legend-color color-male"></div>
                                    <span class="legend-stats">Gar√ßons</span>
                                    <span class="legend-percent" id="boysPercent">0%</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color color-female"></div>
                                    <span class="legend-stats">Filles</span>
                                    <span class="legend-percent" id="girlsPercent">0%</span>
                                </div>
                            </div>
                        </div>

                        <div class="stats-bars">
                            <div class="stat-bar-item">
                                <div class="stat-bar-header">
                                    <span>üèÜ Moyenne Gar√ßons</span>
                                    <span id="boysAvg">0.0</span>
                                </div>
                                <div class="stat-bar-bg">
                                    <div class="stat-bar-fill color-male" id="boysProgress" style="width:0%"></div>
                                </div>
                            </div>
                            
                            <div class="stat-bar-item">
                                <div class="stat-bar-header">
                                    <span>üèÜ Moyenne Filles</span>
                                    <span id="girlsAvg">0.0</span>
                                </div>
                                <div class="stat-bar-bg">
                                    <div class="stat-bar-fill color-female" id="girlsProgress" style="width:0%"></div>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; background: #f8fafc; padding: 15px; border-radius: 20px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: #3b82f6;" id="boysCount">0</div>
                                <div style="font-size: 0.9rem; color: #64748b;">Gar√ßons</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: #ec4899;" id="girlsCount">0</div>
                                <div style="font-size: 0.9rem; color: #64748b;">Filles</div>
                            </div>
                        </div>
                    </div>

                    <!-- Par statut -->
                    <div class="stat-panel">
                        <h2>üìã Statistiques par statut <span id="statusCount">4 cat√©gories</span></h2>

                        <div class="stats-bars">
                            <!-- Nouveaux -->
                            <div class="stat-bar-item">
                                <div class="stat-bar-header">
                                    <span>üÜï Nouveaux</span>
                                    <span><span id="statsNouveau">0</span> √©l. ‚Ä¢ <span id="nouveauAvg">0.0</span>/20</span>
                                </div>
                                <div class="stat-bar-bg">
                                    <div class="stat-bar-fill color-nouveau" id="nouveauBar" style="width:0%"></div>
                                </div>
                            </div>

                            <!-- Nouvelles -->
                            <div class="stat-bar-item">
                                <div class="stat-bar-header">
                                    <span>üÜï Nouvelles</span>
                                    <span><span id="statsNouvelle">0</span> √©l. ‚Ä¢ <span id="nouvelleAvg">0.0</span>/20</span>
                                </div>
                                <div class="stat-bar-bg">
                                    <div class="stat-bar-fill color-nouvelle" id="nouvelleBar" style="width:0%"></div>
                                </div>
                            </div>

                            <!-- Anciens -->
                            <div class="stat-bar-item">
                                <div class="stat-bar-header">
                                    <span>üìö Anciens</span>
                                    <span><span id="statsAncien">0</span> √©l. ‚Ä¢ <span id="ancienAvg">0.0</span>/20</span>
                                </div>
                                <div class="stat-bar-bg">
                                    <div class="stat-bar-fill color-ancien" id="ancienBar" style="width:0%"></div>
                                </div>
                            </div>

                            <!-- Anciennes -->
                            <div class="stat-bar-item">
                                <div class="stat-bar-header">
                                    <span>üìö Anciennes</span>
                                    <span><span id="statsAncienne">0</span> √©l. ‚Ä¢ <span id="ancienneAvg">0.0</span>/20</span>
                                </div>
                                <div class="stat-bar-bg">
                                    <div class="stat-bar-fill color-ancienne" id="ancienneBar" style="width:0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- L√©gende -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border-radius: 4px; background: #10b981;"></div>
                                <span style="font-size: 0.85rem;">Nouveaux</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border-radius: 4px; background: #14b8a6;"></div>
                                <span style="font-size: 0.85rem;">Nouvelles</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border-radius: 4px; background: #f59e0b;"></div>
                                <span style="font-size: 0.85rem;">Anciens</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border-radius: 4px; background: #ef4444;"></div>
                                <span style="font-size: 0.85rem;">Anciennes</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distribution des notes -->
                <div class="chart-box">
                    <h3 style="margin-bottom: 15px;">üìä Distribution des notes</h3>
                    <div id="noteDistribution"></div>
                </div>

                <!-- Historique -->
                <div class="history-section">
                    <h3 style="margin-bottom: 15px;">üìú Historique des alertes</h3>
                    <div id="historyList"></div>
                    <button class="btn btn-primary" onclick="saveStatsToHistory()" style="margin-top:16px; width:100%;">
                        üíæ Sauvegarder l'√©tat actuel
                    </button>
                </div>

                <!-- Actions finales -->
                <div class="actions">
                    <button class="btn btn-success" onclick="exportFullStatsToCSV()">üì• Exporter CSV complet</button>
                    <button class="btn btn-primary" onclick="refreshStats()">üîÑ Actualiser</button>
                    <button class="btn btn-secondary" onclick="goToStep(1)">üîô Changer de classe</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const EXCELLENT_THRESHOLD = 15;
        const CRITICAL_THRESHOLD = 8;
        
        // ==================== DONN√âES ====================
        let classes = {
            '6√®me': [], '5√®me': [], '4√®me': [], '3√®me': [], 
            '2nde': [], '1√®re': [], 'Tle': []
        };
        let currentClass = null;
        let nextId = 1;
        let history = [];
        let currentFilters = { table: '', sex: 'all', status: 'all' };

        // ==================== INITIALISATION ====================
        function loadFromStorage() {
            try {
                const savedClasses = localStorage.getItem('classes');
                if (savedClasses) {
                    classes = JSON.parse(savedClasses);
                }
                const savedHistory = localStorage.getItem('history');
                if (savedHistory) {
                    history = JSON.parse(savedHistory);
                }
                
                // Recalculer le prochain ID disponible
                let maxId = 0;
                for (const cls in classes) {
                    if (Array.isArray(classes[cls])) {
                        classes[cls].forEach(s => { 
                            if (s && s.id > maxId) maxId = s.id; 
                        });
                    }
                }
                nextId = maxId + 1;
                
                updateHistoryList();
            } catch (e) { 
                console.error('Erreur chargement:', e);
                // Initialiser avec des donn√©es par d√©faut si erreur
                classes = {
                    '6√®me': [], '5√®me': [], '4√®me': [], '3√®me': [], 
                    '2nde': [], '1√®re': [], 'Tle': []
                };
                nextId = 1;
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem('classes', JSON.stringify(classes));
                localStorage.setItem('history', JSON.stringify(history));
            } catch (e) {
                console.error('Erreur sauvegarde:', e);
            }
        }

        // ==================== NAVIGATION ====================
        function goToStep(step) {
            for (let i = 1; i <= 4; i++) {
                const content = document.getElementById(`step${i}-content`);
                const stepEl = document.getElementById(`step${i}`);
                if (content) content.classList.remove('active');
                if (stepEl) stepEl.classList.remove('active');
            }
            
            const nextContent = document.getElementById(`step${step}-content`);
            const nextStep = document.getElementById(`step${step}`);
            if (nextContent) nextContent.classList.add('active');
            if (nextStep) nextStep.classList.add('active');
            
            if (step === 3 && currentClass) {
                displayTable();
                const students = classes[currentClass] || [];
                updateQuickStats(students);
            }
            if (step === 4 && currentClass) {
                updateDetailedStats();
                updateAlertLists();
            }
        }

        function selectClass(className) {
            currentClass = className;
            
            const el2 = document.getElementById('currentClass2');
            const el3 = document.getElementById('currentClass3');
            const el4 = document.getElementById('currentClass4');
            
            if (el2) el2.textContent = className;
            if (el3) el3.textContent = className;
            if (el4) el4.textContent = className;
            
            const step1 = document.getElementById('step1');
            if (step1) {
                step1.classList.remove('active');
                step1.classList.add('completed');
            }
            
            updateRegisteredList();
            goToStep(2);
            showMessage(`Classe ${className} s√©lectionn√©e`, 'success');
        }

        // ==================== GESTION √âL√àVES ====================
        function showAddForm() {
            const addForm = document.getElementById('addForm');
            const importForm = document.getElementById('importForm');
            if (addForm) addForm.style.display = 'block';
            if (importForm) importForm.style.display = 'none';
        }

        function showImportForm() {
            const addForm = document.getElementById('addForm');
            const importForm = document.getElementById('importForm');
            if (addForm) addForm.style.display = 'none';
            if (importForm) importForm.style.display = 'block';
        }

        function addStudent() {
            if (!currentClass) return showMessage('S√©lectionnez une classe', 'warning');
            
            const tableNum = document.getElementById('newTableNum')?.value.trim() || '';
            const name = document.getElementById('newName')?.value.trim() || '';
            const parentPhone = document.getElementById('newParentPhone')?.value.replace(/\s/g, '') || '';
            const sex = document.getElementById('newSex')?.value || 'M';
            const status = document.getElementById('newStatus')?.value || 'nouveau';

            if (!tableNum || !name) {
                return showMessage('Veuillez remplir tous les champs', 'warning');
            }
            
            if (!classes[currentClass]) classes[currentClass] = [];
            
            if (classes[currentClass].some(s => s && s.tableNum === tableNum)) {
                return showMessage('Ce num√©ro de table existe d√©j√†', 'warning');
            }

            const newStudent = {
                id: nextId++,
                tableNum: tableNum,
                name: name,
                parentPhone: parentPhone || '',
                sex: sex,
                status: status,
                note: 0,
                notifiedExcellent: false,
                notifiedCritical: false
            };

            classes[currentClass].push(newStudent);
            saveToStorage();
            
            // R√©initialiser les champs
            const tableInput = document.getElementById('newTableNum');
            const nameInput = document.getElementById('newName');
            const phoneInput = document.getElementById('newParentPhone');
            
            if (tableInput) tableInput.value = '';
            if (nameInput) nameInput.value = '';
            if (phoneInput) phoneInput.value = '';
            
            const addForm = document.getElementById('addForm');
            if (addForm) addForm.style.display = 'none';
            
            updateRegisteredList();
            showMessage('√âl√®ve ajout√© avec succ√®s', 'success');
        }

        function deleteStudent(id) {
            if (!currentClass) return;
            
            if (confirm('Supprimer cet √©l√®ve ?')) {
                if (classes[currentClass]) {
                    classes[currentClass] = classes[currentClass].filter(s => s && s.id !== id);
                }
                saveToStorage();
                updateRegisteredList();
                if (document.getElementById('step3-content')?.classList.contains('active')) {
                    displayTable();
                }
                showMessage('√âl√®ve supprim√©', 'success');
            }
        }

        function updateRegisteredList() {
            const tbody = document.getElementById('registeredStudents');
            if (!tbody || !currentClass) return;
            
            const students = classes[currentClass] || [];
            
            tbody.innerHTML = students.map(s => {
                if (!s) return '';
                return `
                <tr>
                    <td>${s.tableNum || ''}</td>
                    <td>${s.name || ''}</td>
                    <td>${s.parentPhone || '‚Äî'}</td>
                    <td><span class="badge ${s.sex === 'M' ? 'sex-m' : 'sex-f'}">${s.sex === 'M' ? 'Masculin' : 'F√©minin'}</span></td>
                    <td><span class="badge status-${s.status || 'nouveau'}">${getStatusLabel(s.status)}</span></td>
                    <td><button class="btn btn-secondary" style="padding:4px 12px;" onclick="deleteStudent(${s.id})">‚úï</button></td>
                </tr>
            `}).join('');
        }

        function getStatusLabel(status) {
            const labels = { 
                'nouveau': 'Nouveau', 
                'nouvelle': 'Nouvelle', 
                'ancien': 'Ancien', 
                'ancienne': 'Ancienne' 
            };
            return labels[status] || status || 'Nouveau';
        }

        // ==================== IMPORT JSON ====================
        function importJSON() {
            if (!currentClass) return showMessage('S√©lectionnez une classe', 'warning');
            
            const jsonText = document.getElementById('jsonImport')?.value;
            if (!jsonText) return showMessage('Entrez des donn√©es JSON', 'warning');
            
            try {
                const data = JSON.parse(jsonText);
                if (!Array.isArray(data)) throw new Error('Le format doit √™tre un tableau');
                
                if (!classes[currentClass]) classes[currentClass] = [];
                
                let count = 0;
                data.forEach(item => {
                    if (item && item.tableNum && item.name && item.sex && item.status) {
                        if (!classes[currentClass].some(s => s && s.tableNum === item.tableNum)) {
                            classes[currentClass].push({
                                id: nextId++,
                                tableNum: item.tableNum,
                                name: item.name,
                                parentPhone: item.parentPhone || '',
                                sex: item.sex,
                                status: item.status,
                                note: item.note || 0,
                                notifiedExcellent: false,
                                notifiedCritical: false
                            });
                            count++;
                        }
                    }
                });
                
                saveToStorage();
                updateRegisteredList();
                showMessage(`${count} √©l√®ve(s) import√©(s) avec succ√®s`, 'success');
                
                const importForm = document.getElementById('importForm');
                if (importForm) importForm.style.display = 'none';
                
            } catch (e) {
                showMessage('Erreur de format JSON : ' + e.message, 'warning');
            }
        }

        function downloadTemplate() {
            const template = [
                {tableNum: "T001", name: "Jean Koffi", parentPhone: "90000000", sex: "M", status: "nouveau", note: 0},
                {tableNum: "T002", name: "Marie Aya", parentPhone: "91000000", sex: "F", status: "nouvelle", note: 0}
            ];
            
            const blob = new Blob([JSON.stringify(template, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'modele_eleves.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ==================== GESTION NOTES ====================
        function getObservation(note) {
            if (note >= 18) return 'üåü Excellent';
            if (note >= 16) return '‚ú® Tr√®s bien';
            if (note >= 14) return 'üìö Bien';
            if (note >= 12) return 'üìñ Assez bien';
            if (note >= 10) return '‚úÖ Passable';
            if (note >= 8) return '‚ö†Ô∏è Insuffisant';
            if (note >= 6) return 'üî¥ Faible';
            return '‚õî Tr√®s faible';
        }

        function getAlertStatus(student) {
            if (!student) return '';
            if (student.note >= EXCELLENT_THRESHOLD) 
                return '<span class="badge-excellent">üèÜ Excellent</span>';
            if (student.note <= CRITICAL_THRESHOLD && student.note > 0) 
                return '<span class="badge-critical">‚ö†Ô∏è Critique</span>';
            return '';
        }

        function displayTable() {
            if (!currentClass) return;
            
            const students = classes[currentClass] || [];
            const filtered = students.filter(s => {
                if (!s) return false;
                const matchTable = !currentFilters.table || 
                    (s.tableNum && s.tableNum.toLowerCase().includes(currentFilters.table.toLowerCase()));
                const matchSex = currentFilters.sex === 'all' || s.sex === currentFilters.sex;
                const matchStatus = currentFilters.status === 'all' || s.status === currentFilters.status;
                return matchTable && matchSex && matchStatus;
            });

            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            
            tbody.innerHTML = filtered.map(s => {
                if (!s) return '';
                return `
                <tr>
                    <td>${s.tableNum || ''}</td>
                    <td>${s.name || ''}</td>
                    <td>${s.parentPhone || '‚Äî'}</td>
                    <td><span class="badge ${s.sex === 'M' ? 'sex-m' : 'sex-f'}">${s.sex === 'M' ? 'M' : 'F'}</span></td>
                    <td><span class="badge status-${s.status || 'nouveau'}">${getStatusLabel(s.status)}</span></td>
                    <td><input type="number" class="note-input" value="${s.note || 0}" min="0" max="20" step="0.5" onchange="updateNote(${s.id}, this.value)"></td>
                    <td>${getObservation(s.note || 0)}</td>
                    <td>${getAlertStatus(s)}</td>
                </tr>
            `}).join('');
            
            updateQuickStats(students);
        }

        function updateNote(id, value) {
            if (!currentClass) return;
            
            const student = classes[currentClass]?.find(s => s && s.id === id);
            if (student) {
                student.note = parseFloat(value) || 0;
                student.notifiedExcellent = false;
                student.notifiedCritical = false;
                saveToStorage();
                displayTable();
            }
        }

        function updateQuickStats(students) {
            const validStudents = students.filter(s => s);
            const total = validStudents.length;
            const boys = validStudents.filter(s => s.sex === 'M').length;
            const girls = validStudents.filter(s => s.sex === 'F').length;
            const sum = validStudents.reduce((acc, s) => acc + (s.note || 0), 0);
            const avg = total ? (sum / total).toFixed(2) : '0.0';
            
            const totalEl = document.getElementById('totalStudents');
            const avgEl = document.getElementById('globalAverage');
            const boysEl = document.getElementById('totalBoys');
            const girlsEl = document.getElementById('totalGirls');
            
            if (totalEl) totalEl.textContent = total;
            if (avgEl) avgEl.textContent = avg;
            if (boysEl) boysEl.textContent = boys;
            if (girlsEl) girlsEl.textContent = girls;
        }

        function applyFilters() {
            const tableFilter = document.getElementById('tableFilter');
            const sexFilter = document.getElementById('sexFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            currentFilters = {
                table: tableFilter ? tableFilter.value.toLowerCase() : '',
                sex: sexFilter ? sexFilter.value : 'all',
                status: statusFilter ? statusFilter.value : 'all'
            };
            displayTable();
        }

        function resetFilters() {
            const tableFilter = document.getElementById('tableFilter');
            const sexFilter = document.getElementById('sexFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            if (tableFilter) tableFilter.value = '';
            if (sexFilter) sexFilter.value = 'all';
            if (statusFilter) statusFilter.value = 'all';
            
            currentFilters = { table: '', sex: 'all', status: 'all' };
            displayTable();
        }

        function saveAllNotes() {
            saveToStorage();
            showMessage('Toutes les notes ont √©t√© enregistr√©es', 'success');
        }

        // ==================== ALERTES ====================
        function updateAlertLists() {
            if (!currentClass) return;
            
            const students = classes[currentClass] || [];
            const validStudents = students.filter(s => s);
            
            const excellent = validStudents.filter(s => s.note >= EXCELLENT_THRESHOLD && s.note > 0)
                .sort((a,b) => b.note - a.note);
            const critical = validStudents.filter(s => s.note <= CRITICAL_THRESHOLD && s.note > 0)
                .sort((a,b) => a.note - b.note);

            const excellentDiv = document.getElementById('excellentStudents');
            const criticalDiv = document.getElementById('criticalStudents');
            
            if (excellentDiv) {
                excellentDiv.innerHTML = excellent.map((s,i) => `
                    <div class="ranking-item">
                        <span class="rank-position">#${i+1}</span>
                        <span class="rank-name">${s.name}</span>
                        <span class="rank-note high">${s.note}/20</span>
                        <span class="rank-actions">
                            ${s.parentPhone ? 
                              `<button class="btn-icon btn-whatsapp" onclick="notifySingleStudent(${s.id}, 'excellent', 'whatsapp')">üì±</button>
                               <button class="btn-icon btn-sms" onclick="notifySingleStudent(${s.id}, 'excellent', 'sms')">üì®</button>` : 
                              '<span style="color:#999;">üìµ</span>'}
                        </span>
                    </div>
                `).join('') || '<p style="padding: 10px; color: #64748b;">Aucun √©l√®ve excellent</p>';
            }

            if (criticalDiv) {
                criticalDiv.innerHTML = critical.map((s,i) => `
                    <div class="ranking-item">
                        <span class="rank-position">#${i+1}</span>
                        <span class="rank-name">${s.name}</span>
                        <span class="rank-note low">${s.note}/20</span>
                        <span class="rank-actions">
                            ${s.parentPhone ? 
                              `<button class="btn-icon btn-whatsapp" onclick="notifySingleStudent(${s.id}, 'critical', 'whatsapp')">üì±</button>
                               <button class="btn-icon btn-sms" onclick="notifySingleStudent(${s.id}, 'critical', 'sms')">üì®</button>` : 
                              '<span style="color:#999;">üìµ</span>'}
                        </span>
                    </div>
                `).join('') || '<p style="padding: 10px; color: #64748b;">Aucun √©l√®ve critique</p>';
            }

            const excellentCount = document.getElementById('excellentCount4');
            const criticalCount = document.getElementById('criticalCount4');
            
            if (excellentCount) excellentCount.textContent = excellent.length;
            if (criticalCount) criticalCount.textContent = critical.length;
        }

        function notifySingleStudent(id, type, method) {
            if (!currentClass) return;
            
            const student = classes[currentClass]?.find(s => s && s.id === id);
            if (!student) return showMessage('√âl√®ve non trouv√©', 'warning');
            if (!student.parentPhone) return showMessage('Num√©ro de parent manquant', 'warning');

            const phone = student.parentPhone.replace(/\s/g, '');
            const message = type === 'excellent' 
                ? `üèÜ F√©licitations ! ${student.name} a obtenu ${student.note}/20. Excellent travail !`
                : `‚ö†Ô∏è Information : ${student.name} a obtenu ${student.note}/20. Un rendez-vous est recommand√©.`;

            if (method === 'whatsapp') {
                window.open(`https://wa.me/228${phone}?text=${encodeURIComponent(message)}`, '_blank');
            } else {
                window.open(`sms:${phone}?body=${encodeURIComponent(message)}`, '_blank');
            }
            showMessage(`Notification envoy√©e √† ${student.name}`, 'success');
        }

        function notifyExcellentStudents() { notifyByThreshold('excellent', 'whatsapp'); }
        function notifyCriticalStudents() { notifyByThreshold('critical', 'whatsapp'); }
        function notifyExcellentStudentsSMS() { notifyByThreshold('excellent', 'sms'); }
        function notifyCriticalStudentsSMS() { notifyByThreshold('critical', 'sms'); }

        function notifyByThreshold(type, method) {
            if (!currentClass) return showMessage('S√©lectionnez une classe', 'warning');
            
            const students = classes[currentClass] || [];
            const validStudents = students.filter(s => s);
            
            const target = validStudents.filter(s => 
                (type === 'excellent' ? s.note >= EXCELLENT_THRESHOLD : s.note <= CRITICAL_THRESHOLD) &&
                s.note > 0 && s.parentPhone &&
                (type === 'excellent' ? !s.notifiedExcellent : !s.notifiedCritical)
            );

            if (target.length === 0) return showMessage('Aucune nouvelle notification √† envoyer', 'warning');

            target.forEach(s => {
                const phone = s.parentPhone.replace(/\s/g, '');
                const message = type === 'excellent'
                    ? `üèÜ F√©licitations ! ${s.name} : ${s.note}/20`
                    : `‚ö†Ô∏è Alerte : ${s.name} : ${s.note}/20`;
                
                if (method === 'whatsapp') {
                    window.open(`https://wa.me/228${phone}?text=${encodeURIComponent(message)}`, '_blank');
                    if (type === 'excellent') s.notifiedExcellent = true;
                } else {
                    window.open(`sms:${phone}?body=${encodeURIComponent(message)}`, '_blank');
                    if (type === 'critical') s.notifiedCritical = true;
                }
            });
            
            saveToStorage();
            updateAlertLists();
            showMessage(`${target.length} notification(s) envoy√©e(s)`, 'success');
        }

        function sendBulkSMS() {
            if (!currentClass) return showMessage('S√©lectionnez une classe', 'warning');
            
            const students = classes[currentClass] || [];
            const withPhone = students.filter(s => s && s.parentPhone);
            
            if (withPhone.length === 0) return showMessage('Aucun parent avec num√©ro renseign√©', 'warning');
            
            const date = new Date().toLocaleDateString('fr-FR');
            withPhone.forEach(s => {
                const msg = `üìä ${s.name} - ${date}: ${s.note || 0}/20 (${getObservation(s.note || 0)})`;
                window.open(`sms:${s.parentPhone}?body=${encodeURIComponent(msg)}`, '_blank');
            });
            
            showMessage('SMS envoy√©s aux parents', 'success');
        }

        function sendStatsToWhatsApp() {
            if (!currentClass) return showMessage('S√©lectionnez une classe', 'warning');
            
            const students = classes[currentClass] || [];
            const validStudents = students.filter(s => s);
            
            if (validStudents.length === 0) return showMessage('Aucun √©l√®ve dans cette classe', 'warning');

            const phoneInput = document.getElementById('whatsappNumber');
            const phone = phoneInput ? phoneInput.value.replace(/\s/g, '') : '';
            
            if (!phone) return showMessage('Entrez un num√©ro WhatsApp', 'warning');

            const total = validStudents.length;
            const avg = (validStudents.reduce((a,b) => a + (b.note || 0), 0) / total).toFixed(2);
            const success = validStudents.filter(s => (s.note || 0) >= 10).length;
            const successRate = ((success / total) * 100).toFixed(1);
            const excellent = validStudents.filter(s => s.note >= EXCELLENT_THRESHOLD).length;
            const critical = validStudents.filter(s => s.note <= CRITICAL_THRESHOLD && s.note > 0).length;

            const message = `üìä *${currentClass}* - ${new Date().toLocaleDateString()}
üë• ${total} √©l√®ves ‚Ä¢ üìä ${avg}/20 ‚Ä¢ ‚úÖ ${successRate}% r√©ussite
üèÜ Excellents: ${excellent} ‚Ä¢ ‚ö†Ô∏è Critiques: ${critical}`;

            window.open(`https://wa.me/228${phone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        // ==================== STATISTIQUES D√âTAILL√âES ====================
        function updateDetailedStats() {
            if (!currentClass) return;
            
            const students = classes[currentClass] || [];
            const validStudents = students.filter(s => s);
            const total = validStudents.length;
            
            if (total === 0) {
                resetStats();
                return;
            }

            // Cartes g√©n√©rales
            const totalEl = document.getElementById('totalStudents4');
            const avgEl = document.getElementById('globalAvg4');
            const successEl = document.getElementById('successRate4');
            const maxEl = document.getElementById('maxNote4');
            
            const sum = validStudents.reduce((acc, s) => acc + (s.note || 0), 0);
            const avg = (sum / total).toFixed(2);
            const success = validStudents.filter(s => (s.note || 0) >= 10).length;
            const successRate = ((success / total) * 100).toFixed(1);
            const notes = validStudents.map(s => s.note || 0);
            
            if (totalEl) totalEl.textContent = total;
            if (avgEl) avgEl.textContent = avg;
            if (successEl) successEl.textContent = successRate + '%';
            if (maxEl) maxEl.textContent = Math.max(...notes);
            
            // Par sexe
            const boys = validStudents.filter(s => s.sex === 'M');
            const girls = validStudents.filter(s => s.sex === 'F');
            
            const boysCount = boys.length;
            const girlsCount = girls.length;
            
            const boysCountEl = document.getElementById('boysCount');
            const girlsCountEl = document.getElementById('girlsCount');
            const sexCountEl = document.getElementById('sexCount');
            
            if (boysCountEl) boysCountEl.textContent = boysCount;
            if (girlsCountEl) girlsCountEl.textContent = girlsCount;
            if (sexCountEl) sexCountEl.textContent = total + ' √©l√®ves';
            
            const boysPct = ((boysCount / total) * 100).toFixed(1);
            const girlsPct = ((girlsCount / total) * 100).toFixed(1);
            
            const boysPercentEl = document.getElementById('boysPercent');
            const girlsPercentEl = document.getElementById('girlsPercent');
            
            if (boysPercentEl) boysPercentEl.textContent = boysPct + '%';
            if (girlsPercentEl) girlsPercentEl.textContent = girlsPct + '%';
            
            const pieChart = document.getElementById('sexPieChart');
            if (pieChart && total > 0) {
                pieChart.style.background = 
                    `conic-gradient(#3b82f6 0% ${boysPct}%, #ec4899 ${boysPct}% 100%)`;
            }
            
            const boysAvg = boysCount ? (boys.reduce((acc, s) => acc + (s.note || 0), 0) / boysCount).toFixed(2) : '0.0';
            const girlsAvg = girlsCount ? (girls.reduce((acc, s) => acc + (s.note || 0), 0) / girlsCount).toFixed(2) : '0.0';
            
            const boysAvgEl = document.getElementById('boysAvg');
            const girlsAvgEl = document.getElementById('girlsAvg');
            
            if (boysAvgEl) boysAvgEl.textContent = boysAvg;
            if (girlsAvgEl) girlsAvgEl.textContent = girlsAvg;
            
            const boysProgress = document.getElementById('boysProgress');
            const girlsProgress = document.getElementById('girlsProgress');
            
            if (boysProgress) boysProgress.style.width = (parseFloat(boysAvg) / 20 * 100) + '%';
            if (girlsProgress) girlsProgress.style.width = (parseFloat(girlsAvg) / 20 * 100) + '%';
            
            // Par statut
            const statuses = ['nouveau', 'nouvelle', 'ancien', 'ancienne'];
            statuses.forEach(status => {
                const filtered = validStudents.filter(s => s.status === status);
                const count = filtered.length;
                const avgStatus = count ? (filtered.reduce((acc, s) => acc + (s.note || 0), 0) / count).toFixed(2) : '0.0';
                
                const countEl = document.getElementById(`stats${status.charAt(0).toUpperCase() + status.slice(1)}`);
                const avgEl = document.getElementById(`${status}Avg`);
                
                if (countEl) countEl.textContent = count;
                if (avgEl) avgEl.textContent = avgStatus;
                
                const bar = document.getElementById(`${status}Bar`);
                if (bar) {
                    bar.style.width = (parseFloat(avgStatus) / 20 * 100) + '%';
                }
            });

            // Distribution des notes
            updateNoteDistribution(validStudents);
        }

        function updateNoteDistribution(students) {
            const intervals = [
                {min:18, max:20, label:'18 - 20'}, {min:16, max:17.99, label:'16 - 18'}, 
                {min:14, max:15.99, label:'14 - 16'}, {min:12, max:13.99, label:'12 - 14'},
                {min:10, max:11.99, label:'10 - 12'}, {min:8, max:9.99, label:'8 - 10'},
                {min:6, max:7.99, label:'6 - 8'}, {min:0, max:5.99, label:'0 - 6'}
            ];
            
            const total = students.length;
            const distEl = document.getElementById('noteDistribution');
            
            if (!distEl) return;
            
            distEl.innerHTML = intervals.map(i => {
                const count = students.filter(s => (s.note || 0) >= i.min && (s.note || 0) <= i.max).length;
                const pct = total ? ((count/total)*100).toFixed(1) : 0;
                return `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span>${i.label}</span>
                            <span>${count} (${pct}%)</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-fill" style="width:${pct}%; background: #4f46e5;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function resetStats() {
            const ids = [
                'totalStudents4', 'globalAvg4', 'successRate4', 'maxNote4', 
                'excellentCount4', 'criticalCount4', 'boysCount', 'girlsCount',
                'boysPercent', 'girlsPercent', 'boysAvg', 'girlsAvg',
                'statsNouveau', 'statsNouvelle', 'statsAncien', 'statsAncienne',
                'nouveauAvg', 'nouvelleAvg', 'ancienAvg', 'ancienneAvg'
            ];
            
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = id.includes('Rate') ? '0%' : '0';
            });
            
            const sexCount = document.getElementById('sexCount');
            if (sexCount) sexCount.textContent = '0 √©l√®ves';
            
            const pieChart = document.getElementById('sexPieChart');
            if (pieChart) pieChart.style.background = '#f1f5f9';
            
            const progressBars = [
                'boysProgress', 'girlsProgress', 'nouveauBar', 
                'nouvelleBar', 'ancienBar', 'ancienneBar'
            ];
            
            progressBars.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.width = '0%';
            });
        }

        function refreshStats() {
            updateDetailedStats();
            updateAlertLists();
            showMessage('Statistiques actualis√©es', 'success');
        }

        // ==================== HISTORIQUE ====================
        function saveStatsToHistory() {
            if (!currentClass) return showMessage('S√©lectionnez une classe', 'warning');
            
            const students = classes[currentClass] || [];
            const validStudents = students.filter(s => s);
            
            if (validStudents.length === 0) return showMessage('Aucun √©l√®ve dans cette classe', 'warning');
            
            const entry = {
                date: new Date().toLocaleString('fr-FR'),
                class: currentClass,
                students: validStudents.length,
                average: (validStudents.reduce((a,b) => a + (b.note || 0), 0) / validStudents.length).toFixed(2),
                success: validStudents.filter(s => (s.note || 0) >= 10).length,
                excellent: validStudents.filter(s => s.note >= EXCELLENT_THRESHOLD).length,
                critical: validStudents.filter(s => s.note <= CRITICAL_THRESHOLD && s.note > 0).length
            };
            
            history.unshift(entry);
            if (history.length > 10) history.pop();
            
            saveToStorage();
            updateHistoryList();
            showMessage('√âtat sauvegard√© dans l\'historique', 'success');
        }

        function updateHistoryList() {
            const list = document.getElementById('historyList');
            if (!list) return;
            
            if (history.length === 0) {
                list.innerHTML = '<p style="text-align:center; padding: 20px; color:#64748b;">Aucun historique</p>';
                return;
            }
            
            list.innerHTML = history.map(h => `
                <div class="history-item">
                    <span style="font-weight:600;">${h.class}</span>
                    <div class="history-stats">
                        <span>üìÖ ${h.date}</span>
                        <span>üë• ${h.students}</span>
                        <span>üìä ${h.average}</span>
                        <span>‚úÖ ${h.success}</span>
                        <span>üèÜ ${h.excellent}</span>
                        <span>‚ö†Ô∏è ${h.critical}</span>
                    </div>
                </div>
            `).join('');
        }

        // ==================== EXPORT CSV ====================
        function exportFullStatsToCSV() {
            if (!currentClass) return showMessage('S√©lectionnez une classe', 'warning');
            
            const students = classes[currentClass] || [];
            const validStudents = students.filter(s => s);
            
            if (validStudents.length === 0) return showMessage('Aucun √©l√®ve dans cette classe', 'warning');

            let csv = "Table,Nom,T√©l√©phone,Sexe,Statut,Note,Observation,Alerte\n";
            
            validStudents.forEach(s => {
                const alert = s.note >= EXCELLENT_THRESHOLD ? 'Excellent' :
                             (s.note <= CRITICAL_THRESHOLD && s.note > 0 ? 'Critique' : 'Normal');
                csv += `${s.tableNum},${s.name},${s.parentPhone || ''},${s.sex},${s.status},${s.note || 0},${getObservation(s.note || 0)},${alert}\n`;
            });

            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentClass}_complet.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('Export CSV r√©ussi', 'success');
        }

        // ==================== MESSAGES ====================
        function showMessage(text, type) {
            const alertDiv = document.getElementById('alertMessage2');
            if (!alertDiv) return;
            
            alertDiv.textContent = text;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // ==================== INITIALISATION ====================
        loadFromStorage();
    </script>
</body>
</html>
